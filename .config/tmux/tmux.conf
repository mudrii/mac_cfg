# ============================================
# Tmux Configuration
# ============================================
# Optimized for macOS with Neovim integration
# Theme: Catppuccin Macchiato (matches Neovim/Ghostty)
#
# Prefix: Ctrl-a
#
# WINDOWS:
#   c             New window (in current path)
#   ,             Rename window
#   n/p           Next/previous window
#   C-h/C-l       Select window left/right
#   &             Kill window
#   1-9           Select window by number
#
# PANES:
#   -             Split horizontal (in current path)
#   =             Split vertical (in current path)
#   h/j/k/l       Navigate panes (vim-style)
#   H/J/K/L       Resize panes
#   </>/          Swap panes
#   x             Kill pane
#   z             Toggle zoom
#   !             Break pane to new window
#
# SESSIONS:
#   S             Choose session
#   N             New session
#   $             Rename session
#   X             Kill session (with confirmation)
#   d             Detach
#   (/)           Previous/next session
#
# COPY MODE:
#   Escape        Enter copy mode
#   v             Begin selection
#   C-v           Rectangle selection
#   y             Copy selection (to clipboard)
#   /             Search forward
#   ?             Search backward
#
# OTHER:
#   r             Reload config
#   C-a C-a       Last window
#   C-f           Find session
#   a             Send Ctrl-a to application (for line beginning)
#   C-;           Clear screen (bypasses vim-tmux-navigator)
#   C-q           Kill line forward (bypasses vim-tmux-navigator)
# ============================================

# ============================================
# Terminal Settings
# ============================================

# Use tmux-256color for proper color support
# This enables true color (24-bit) in Neovim and other applications
set -g default-terminal "tmux-256color"

# Enable true color support for various terminal types
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",*256col*:RGB"
set -ag terminal-overrides ",alacritty:RGB"
set -ag terminal-overrides ",ghostty:RGB"

# Undercurl support (for Neovim LSP diagnostics)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Default shell - use default-command to start a non-login shell
# This prevents double shell initialization
set -g default-shell /bin/zsh
set -g default-command "zsh"

# Large scrollback buffer
set -g history-limit 50000

# ============================================
# Prefix Key
# ============================================

# Change prefix from Ctrl-b to Ctrl-a (easier to reach)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Send Ctrl-a to application (for going to beginning of line in shell)
# Press Ctrl-a then 'a' to send actual Ctrl-a
bind a send-keys C-a

# ============================================
# General Settings
# ============================================

# Start window and pane numbering at 1 (easier to reach)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable mouse support (scrolling, pane selection, resizing)
set -g mouse on

# Lower escape time for faster command sequences
set -s escape-time 0

# Extended keys - pass through Shift+Enter and other modified keys (CSI u / Kitty protocol)
set -s extended-keys always
set -s extended-keys-format csi-u
set -as terminal-features 'xterm-ghostty:extkeys'

# Increase repeat time for repeatable commands
set -g repeat-time 400

# Focus events for Neovim autoread
set -s focus-events on

# Don't rename windows automatically
setw -g automatic-rename off

# Allow programs to rename windows
set -g allow-rename on

# Set terminal title
set -g set-titles on
set -g set-titles-string '#S:#I:#W - #{pane_current_path}'

# Activity monitoring (subtle notification)
setw -g monitor-activity on
set -g visual-activity off

# Bell settings
set -g visual-bell off
set -g bell-action none

# Display settings
set -g display-panes-time 800
set -g display-time 1500
set -g status-interval 5

# ============================================
# Key Bindings - General
# ============================================

# Reload configuration
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# Quick switch to last window
bind-key C-a last-window

# Pass through xterm keys
set -g xterm-keys on

# ============================================
# Key Bindings - Windows
# ============================================

# Create new window in current path
bind c new-window -c "#{pane_current_path}"

# Window navigation
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# ============================================
# Key Bindings - Panes
# ============================================

# Split panes using - and = (keeping current path)
unbind %
unbind '"'
bind - split-window -v -c "#{pane_current_path}"
bind = split-window -h -c "#{pane_current_path}"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing (repeatable with -r)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Maximize/restore pane
bind m resize-pane -Z

# ============================================
# Key Bindings - Sessions
# ============================================

# Session management
bind S choose-session
bind N new-session
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# Find session
bind C-f command-prompt -p "Find session:" "switch-client -t %%"

# Switch between sessions
bind -r ( switch-client -p
bind -r ) switch-client -n

# ============================================
# Copy Mode (Vi-style)
# ============================================

# Use vi keys in copy mode
setw -g mode-keys vi

# Enter copy mode
bind Escape copy-mode
bind -n M-Up copy-mode

# Vi-style selection and copying
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel

# macOS clipboard integration
set -g set-clipboard on
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Double click to select word
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word
bind -n DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word

# Triple click to select line
bind -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line
bind -n TripleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-line

# ============================================
# Status Bar Position
# ============================================

set -g status-position bottom
set -g status on

# ============================================
# TPM Plugins
# ============================================
# Install TPM: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Install plugins: prefix + I
# Update plugins: prefix + U
# Remove unused: prefix + alt + u

# TPM - Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Sensible defaults
set -g @plugin 'tmux-plugins/tmux-sensible'

# Catppuccin theme (matches Neovim/Ghostty)
set -g @plugin 'catppuccin/tmux#v2.1.2'
set -g @catppuccin_flavor 'macchiato'

# Window styling - simple arrow style: "1 > zsh -"
set -g @catppuccin_window_status_style 'basic'
set -g @catppuccin_window_left_separator ''
set -g @catppuccin_window_right_separator ''
set -g @catppuccin_window_middle_separator ' > '
set -g @catppuccin_window_number_position 'left'

# Window format: just show name and flags (number comes from fill)
set -g @catppuccin_window_default_fill 'number'
set -g @catppuccin_window_default_text '#W'
set -g @catppuccin_window_current_fill 'number'
set -g @catppuccin_window_current_text '#W'

# Status bar - right side shows date and host
set -g @catppuccin_status_modules_right 'date_time host'
set -g @catppuccin_status_modules_left ''
set -g @catppuccin_status_left_separator ''
set -g @catppuccin_status_right_separator ''
set -g @catppuccin_status_connect_separator 'no'

# Date/time format
set -g @catppuccin_date_time_text '%Y-%m-%d %H:%M'

# Host display
set -g @catppuccin_host_text '#H'

# Better mouse mode
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @scroll-without-changing-pane 'on'
set -g @scroll-speed-num-lines-per-scroll '3'
set -g @emulate-scroll-for-no-mouse-alternate-buffer 'on'

# Session persistence (save/restore sessions)
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'nvim vim ssh'

# Auto-save sessions
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'off'
set -g @continuum-save-interval '15'

# Yank to system clipboard
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'

# Open URLs and files
set -g @plugin 'tmux-plugins/tmux-open'

# Seamless navigation between tmux panes and vim splits
# Use Ctrl-h/j/k/l to navigate in both tmux and vim
set -g @plugin 'christoomey/vim-tmux-navigator'

# ============================================
# Initialize TPM
# ============================================
# Keep this line at the very bottom of tmux.conf
run '~/.tmux/plugins/tpm/tpm'

# Ctrl-q to clear line forward (since Ctrl-k is used by vim-tmux-navigator)
bind -n C-q send-keys C-k

# Ctrl-; to clear screen (since Ctrl-l is used by vim-tmux-navigator)
# Requires extended-keys (CSI-u) to distinguish Ctrl-; from plain ;
bind -n 'C-;' send-keys C-l

# ============================================
# Quick Reference
# ============================================
#
# Plugin Management:
#   prefix + I        Install plugins
#   prefix + U        Update plugins
#   prefix + alt + u  Remove unused plugins
#
# Session Persistence:
#   prefix + Ctrl-s   Save session
#   prefix + Ctrl-r   Restore session
#
# Vim-Tmux Navigator:
#   Ctrl-h/j/k/l      Navigate panes (works in vim too)
#
# ============================================
